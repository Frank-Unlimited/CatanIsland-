# 强盗逻辑实现说明

## 概述
强盗是卡坦岛游戏中的核心机制，用于控制资源、压制对手、抢夺节奏。本文档详细说明了强盗逻辑的完整实现。

## 触发条件

### 1. 掷出7点
当玩家掷骰子总和为7时，自动触发强盗事件。

### 2. 使用骑士卡
玩家可以在主回合使用骑士卡（发展卡的一种），主动触发强盗移动。

## 完整流程

### 第一步：资源弃牌（掷出7时）
```
条件：所有玩家手牌 > 7张
规则：弃掉一半资源（向下取整）
示例：
  - 8张 → 弃4张
  - 9张 → 弃4张
  - 10张 → 弃5张
```

**实现位置：** `gameService.ts` → `handleSevenRoll()` → `discardRandomResources()`

**注意事项：**
- 当前实现为随机弃牌
- 实际游戏中玩家可以自选弃哪些资源
- 所有玩家同时弃牌，包括掷骰者

### 第二步：强盗移动
```
阶段：ROBBER_PLACEMENT
规则：
  - 必须移动到新位置（不能停在原地）
  - 可以移动到任意地形板块（包括沙漠）
  - 无距离限制，可跨地图移动
```

**实现位置：** `gameService.ts` → `moveRobber(hexId)`

**UI交互：**
- 地图上所有未被强盗占据的板块高亮显示
- 鼠标悬停时板块变亮
- 点击板块完成移动

### 第三步：资源偷窃（可选）
```
条件：新位置有其他玩家的建筑相邻
规则：
  - 只能偷取资源卡，不能偷取发展卡
  - 随机选择受害者的一种资源
  - 如果受害者没有资源，无法偷取
```

**实现位置：** `gameService.ts` → `stealFrom(victimId)`

**UI交互：**
- 弹出模态框显示可偷取的玩家
- 显示玩家头像和名称
- 点击选择偷取目标

## 强盗的作用

### 1. 资源封锁
被强盗占据的板块：
- 停止产出资源
- 即使掷到对应数字也不产出
- 直到强盗被移走

**实现位置：** `gameService.ts` → `distributeResources()`
```typescript
// 过滤掉被强盗占据的板块
.filter(h => h.numberToken === roll && !h.hasRobber)
```

### 2. 资源掠夺
- 直接从对手处偷取1张资源卡
- 削弱对手的购买力
- 弥补自身资源缺口

### 3. 节奏控制
- 迫使囤牌玩家弃资源
- 阻止对手一次性爆发建造
- 打破对手资源垄断

### 4. 骑士卡联动
- 使用骑士卡可主动移动强盗
- 累计打出3张骑士卡可获得"最大军队"成就（2胜利点）
- 不用等待掷出7点

## 游戏阶段说明

### ROLL_DICE（掷骰阶段）
- 玩家必须先掷骰子
- 掷出7触发强盗事件
- 其他点数正常分配资源

### ROBBER_PLACEMENT（强盗移动阶段）
- 玩家选择强盗的新位置
- 地图上所有板块可点击（除当前位置）
- 移动完成后检查是否有偷窃目标

### ROBBER_STEAL（强盗偷窃阶段）
- 显示所有可偷取的玩家
- 玩家选择偷取目标
- 随机偷取1张资源卡
- 完成后进入主回合

### MAIN_TURN（主回合阶段）
- 可以交易、建造、使用发展卡
- 可以使用骑士卡触发强盗移动

## 代码结构

### 核心文件
```
fronted/
├── services/
│   └── gameService.ts          # 强盗逻辑核心实现
├── components/
│   ├── Map/
│   │   ├── CatanMap.tsx        # 强盗UI交互
│   │   └── HexTile.tsx         # 强盗渲染
│   └── UI/
│       └── ActionPanel.tsx     # 骑士卡使用
└── types.ts                    # 游戏阶段定义
```

### 关键函数

#### gameService.ts
- `rollDice()` - 掷骰子，检测是否为7
- `handleSevenRoll()` - 处理掷出7的完整流程
- `discardRandomResources()` - 随机弃牌
- `moveRobber(hexId)` - 移动强盗到指定板块
- `stealFrom(victimId)` - 从指定玩家偷取资源
- `distributeResources(roll)` - 分配资源（过滤强盗板块）
- `playDevelopmentCard(cardId)` - 使用骑士卡

#### CatanMap.tsx
- 渲染强盗移动模式的高亮效果
- 显示强盗偷窃阶段的选择界面
- 处理板块点击事件

#### HexTile.tsx
- 渲染强盗标记
- 强盗占据时隐藏数字圆片
- 强盗移动模式下的悬停效果

## 待优化功能

### 1. 玩家自选弃牌
当前实现为随机弃牌，可以改进为：
- 弹出资源选择界面
- 玩家手动选择要弃掉的资源
- 确认后执行弃牌

### 2. 最大军队成就
- 追踪每个玩家的骑士卡数量
- 达到3张时授予"最大军队"成就（2胜利点）
- 可被其他玩家超越

### 3. 强盗移动动画
- 添加强盗从旧位置移动到新位置的动画
- 提升视觉体验

### 4. AI强盗策略
- AI选择强盗位置时考虑战略价值
- 优先封锁对手高产板块
- 优先偷取资源多的玩家

## 测试建议

### 测试场景
1. 掷出7点，手牌>7张的玩家正确弃牌
2. 强盗移动到新位置，旧位置恢复产出
3. 强盗占据的板块停止产出资源
4. 有相邻玩家时正确进入偷窃阶段
5. 无相邻玩家时直接进入主回合
6. 使用骑士卡正确触发强盗移动
7. 强盗不能移动到当前位置

### 调试模式
使用调试模式可以：
- 手动设置玩家资源
- 测试不同的强盗场景
- 验证资源分配逻辑

## 总结

强盗机制是卡坦岛游戏的核心玩法之一，通过：
- **资源封锁** - 控制关键板块的产出
- **资源掠夺** - 直接削弱对手实力
- **节奏控制** - 防止资源囤积和爆发
- **战术选择** - 骑士卡提供主动控制能力

实现时需要注意：
- 严格按照游戏阶段执行
- 正确处理边界情况（无资源、无相邻玩家等）
- 提供清晰的UI反馈
- 保持代码的可维护性和可扩展性
